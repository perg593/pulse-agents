<script>
var conditionalConfig = [
    {
      'id': 9304,
      'answers': {
        26495 : [9305, 9307, 9308, 9312, 9314], //website
        26496 : [9305, 9307, 9309, 9313, 9314], //apps
        26497 : [9305, 9307, 9310, 9314], //retail
        26498 : [9305, 9306, 9307], //products
        26499 : [9305, 9307, 9311], //customer service
        26500 : [9307, 9315], //nike
        26501 : [9307] //other
      }
    },
];
var conditionalConfig = [
    {
      'id': 9385,
      'answers': {
        26800 : [9386 /*stars*/, 9390 /*free text*/,9391 ,9395], //website
        26801 : [9386 /*stars*/, 9388/*which app*/ ,9390 /*free text*/], //apps
        26802 : [9386 /*stars*/, 9390 /*free text*/, 9392 /*store goal*/,9395 /*how easy*/], //retail
        26803 : [9386 /*stars*/, 9389 /*product type*/, 9390 /*free text*/], //products
        26804 : [9386 /*stars*/, 9390 /*free text*/, 9393/*support*/], //customer service
        26805 : [9387 /*aspect of nike*/, 9390 /*free text*/], //nike
        26806 : [9390 /*free text*/] //other
      }
    },
    {
      'id': 9388,
      'answers': {
        26819 : [9394 /*primary app goal*/, 9395 /*how easy*/]
      }
    }
];
// GB en
var conditionalConfig = [
    {
      'id': 9436,
      'answers': {
        27009 : [9437 /*stars*/, 9441 /*free text*/,9442 ,9446], //website
        27010 : [9437 /*stars*/, 9439/*which app*/ ,9441 /*free text*/], //apps
        27011 : [9437 /*stars*/, 9441 /*free text*/, 9443 /*store goal*/,9446 /*how easy*/], //retail
        27012 : [9437 /*stars*/, 9440 /*product type*/, 9441 /*free text*/], //products
        27013 : [9437 /*stars*/, 9441 /*free text*/, 9444/*support*/], //customer service
        27014 : [9438 /*aspect of nike*/, 9441 /*free text*/], //nike
        27015 : [9441 /*free text*/] //other
      }
    },
    {
      'id': 9439,
      'answers': {
        27028 : [9445 /*primary app goal*/, 9446 /*how easy*/]
      }
    }
];

// us es
var conditionalConfig = [
    {
      'id': 9409,
      'answers': {
        26880 : [9410 /*stars*/, 9414 /*free text*/,9415 ,9419], //website
        26881 : [9410 /*stars*/, 9412/*which app*/ ,9414 /*free text*/], //apps
        26882 : [9410 /*stars*/, 9414 /*free text*/, 9416 /*store goal*/,9419 /*how easy*/], //retail
        26883 : [9410 /*stars*/, 9413 /*product type*/, 9414 /*free text*/], //products
        26884 : [9410 /*stars*/, 9414 /*free text*/, 9417/*support*/], //customer service
        26885 : [9411 /*aspect of nike*/, 9414 /*free text*/], //nike
        26886 : [9414 /*free text*/] //other
      }
    },
    {
      'id': 9412,
      'answers': {
        26899 : [9418 /*primary app goal*/, 9419 /*how easy*/]
      }
    }
];

//uk gb copy
var conditionalConfig = [
    {
      'id': 9515,
      'answers': {
        27259 : [9516 /*stars*/, 9520 /*free text*/,9521 ,9525], //website
        27260 : [9516 /*stars*/, 9518/*which app*/ ,9520 /*free text*/], //apps
        27261 : [9516 /*stars*/, 9520 /*free text*/, 9522 /*store goal*/,9525 /*how easy*/], //retail
        27262 : [9516 /*stars*/, 9519 /*product type*/, 9520 /*free text*/], //products
        27263 : [9516 /*stars*/, 9520 /*free text*/, 9523/*support*/], //customer service
        27264 : [9517 /*aspect of nike*/, 9520 /*free text*/], //nike
        27265 : [9520 /*free text*/] //other
      }
    },
    {
      'id': 9518,
      'answers': {
        27278 : [9524 /*primary app goal*/, 9525 /*how easy*/]
      }
    }
];


var conditionalConfig = [
{
  'id': 8836,
  'answers': {
    25229 : [8837], //website
    25230 : [8837, 8838], //apps
  }
},
];
Array.prototype.unique = function() {
  var a = this.concat();
  for(var i=0; i<a.length; ++i) {
      for(var j=i+1; j<a.length; ++j) {
          if(a[i] === a[j])
              a.splice(j--, 1);
      }
  }

  return a;
};

Array.prototype.contains = function(obj) {
    var i = this.length;
    while (i--) {
        if (this[i] === obj) {
            return true;
        }
    }
    return false;
}

function Question(args){
  this.id = args.id;
  this.answers = args.answers;
  this.question = this.getPulseQuestion(this.id);
  this.dependents = this.getDependents();
  this.dependentQuestions = this.getSubUnits();
  this.subUnits = this.getSubUnits();
  this.currentAnswer = 0;
  this.attachEvents();
}
Question.prototype.getSubUnits = function(){
  var getPreviousSibling = function (elem, className) {

    // Get the next sibling element
    var sibling = elem.previousElementSibling;

    // If there's no className, return the first sibling
    if (!className) return sibling;

    // If the sibling matches our className, use it
    // If not, jump to the next sibling and continue the loop
    while (sibling) {
      if (sibling.classList.contains(className)) return sibling;
      sibling = sibling.previousElementSibling;
    }

  };
  var getNextSibling = function (elem, className) {

    // Get the next sibling element
    var sibling = elem.nextElementSibling;

    // If the sibling matches our className, use it
    // If not, jump to the next sibling and continue the loop
    while (sibling) {
      if (sibling.classList.contains(className)) return sibling;
      sibling = sibling.nextElementSibling;
    }

  };
  dependentQuestions = {};
  for (var i = 0; i < this.dependents.length; i++) {
    //get question el
    dependentQuestions[this.dependents[i]] = this.getPulseQuestion(this.dependents[i]);
    baseEl = PulseInsightsObject.survey.widgetContainer.querySelector('._pi_answers_container[data-question-id="'+ dependentQuestions[this.dependents[i]].id +'"]');

    // if(optional == "f"){
      //need to handle optional stuff
    // }
    dependentQuestions[this.dependents[i]].baseEl = baseEl;
    dependentQuestions[this.dependents[i]].questionEl = getPreviousSibling(baseEl, '_pi_question');
    if((dependentQuestions[this.dependents[i]].after_answers_count != "0" && dependentQuestions[this.dependents[i]].after_answers_count != "") && (dependentQuestions[this.dependents[i]].after_answers_items != null && dependentQuestions[this.dependents[i]].after_answers_items != '["", ""]') && dependentQuestions[this.dependents[i]].button_type === 1 && dependentQuestions[this.dependents[i]].question_type == "single_choice_question"){
      // get after answer el
      dependentQuestions[this.dependents[i]].afterAnswersEl = getNextSibling(baseEl, '_pi_scale_container_after');
    }
    else{
      dependentQuestions[this.dependents[i]].afterAnswersEl = null;
    }
    if(dependentQuestions[this.dependents[i]].before_answers_count != "0" && dependentQuestions[this.dependents[i]].before_answers_items != null & dependentQuestions[this.dependents[i]].button_type === 1 && dependentQuestions[this.dependents[i]].question_type == "single_choice_question"){
      // get before answer el
      dependentQuestions[this.dependents[i]].beforeAnswersEl = getPreviousSibling(baseEl, '_pi_scale_container_before');
    }
    else{
      dependentQuestions[this.dependents[i]].beforeAnswersEl = null;
    }
    if((dependentQuestions[this.dependents[i]].before_answers_count != "0" && dependentQuestions[this.dependents[i]].before_answers_count != "") && (dependentQuestions[this.dependents[i]].before_answers_items != null && dependentQuestions[this.dependents[i]].before_answers_items != '["", ""]') && dependentQuestions[this.dependents[i]].button_type === 1 && dependentQuestions[this.dependents[i]].question_type == "single_choice_question" ){
      // get before question el
      dependentQuestions[this.dependents[i]].beforeQuestionEl = getPreviousSibling(baseEl, 'pi_header_before');
    }
    else{
      dependentQuestions[this.dependents[i]].beforeQuestionEl = null;
    }
    if(dependentQuestions[this.dependents[i]].after_question_text != "" && dependentQuestions[this.dependents[i]].after_question_text !== null && dependentQuestions[this.dependents[i]].button_type === 1 && dependentQuestions[this.dependents[i]].question_type == "single_choice_question" ){
      // get after question el
      dependentQuestions[this.dependents[i]].afterQuestionEl = getPreviousSibling(baseEl, 'pi_header_after');
    }
    else{
      dependentQuestions[this.dependents[i]].afterQuestionEl = null;
    }
    // id: 8961
  }
  return dependentQuestions;
}
Question.prototype.attachEvents = function(){
  // single choice
  if(this.question.question_type == "single_choice_question"){
    // normal single choice

    if(this.question.button_type === 0 || this.question.button_type === 1){
      var els = PulseInsightsObject.survey.widget.querySelectorAll('._pi_answers_container[data-question-id="'+ this.question.id +'"] li a');
      var el;
      var self = this;
      for (var i = 0; i < els.length; i++) {
        // el = PulseInsightsObject.survey.widget.querySelector('[data-answer-id="' + this.answers[i].id + '"]');
        var elId = els[i].getAttribute('data-answer-id');


          // console.log('hello');
          // console.log(els[i]);

          el = els[i];
          el.addEventListener('click', function(){
            self.currentAnswer =  parseInt(this.getAttribute('data-answer-id'));
            if(typeof self.answers[self.currentAnswer] != 'undefined'){
              self.showQuestions();
            }
            else{
              self.hideQuestions();
            }

          });
        }

    }
    // select input
    else if(this.question.button_type === 2){
      var el = PulseInsightsObject.survey.widget.querySelector('._pi_answers_container[data-question-id="'+ this.question.id +'"] select._pi_select');

      el.addEventListener('change', function(e){
        if(typeof this.answers[el.value] != 'undefined'){
          this.currentAnswer =  parseInt(el.value);
          this.showQuestions();
        }
        else{
          this.hideQuestions();
        }
      }.bind(this));
    }
  }
  // multiple choice
  else if(this.question.question_type == "multiple_choices_question"){
    var parentEl = PulseInsightsObject.survey.widget.querySelector('._pi_answers_container[data-question-id="'+ this.question.id +'"]'),
        els = parentEl.querySelectorAll('li label'),
        keys;
    for (var i = 0; i < els.length; i++) {
      els[i].addEventListener('click', function(e){
        keys = Object.keys(this.answers);
        for (var j = 0; j < keys.length; j++) {
          if(parentEl.getAttribute('data-answer').indexOf(keys[j]) !== -1){
            this.currentAnswer =  parseInt(keys[j]);
            this.showQuestions();
          }
          else{
            this.hideQuestions();
          }
        }
      }).bind(this);
    }
  }
}
Question.prototype.getPulseQuestion = function(id){
  for (var i = 0; i < PulseInsightsObject.survey.questions.length; i++) {
    if(PulseInsightsObject.survey.questions[i].id === id){
      return PulseInsightsObject.survey.questions[i];
    }
  }
}
Question.prototype.getDependents = function(){
  var dependents = [],
      keys = Object.keys(this.answers);
  for (var i = 0; i < keys.length; i++) {
    dependents = dependents.concat(this.answers[keys[i]]).unique();
  }
  return dependents;
}
Question.prototype.showQuestions = function(){
  //check and see if its already shown
  // console.log('show');
  // console.log(dependents);
  var dependents = this.answers[this.currentAnswer];
  this.hideQuestions();
  if(typeof dependents !== 'undefined'){
    for (var i = 0; i < dependents.length; i++) {
      this.subUnits[dependents[i]].questionEl.style.setProperty("display", "flex", "important");
      this.subUnits[dependents[i]].baseEl.style.setProperty("display", "flex", "important");
      if(this.subUnits[dependents[i]].optional == "f" && this.subUnits[dependents[i]].question_type != "custom_content_question"){
        this.subUnits[dependents[i]].baseEl.setAttribute("data-question-optional", "f");
      }

      if(this.subUnits[dependents[i]].afterAnswersEl != null){
        this.subUnits[dependents[i]].afterAnswersEl.style.setProperty("display", "flex", "important")
      }
      if(this.subUnits[dependents[i]].beforeAnswersEl != null){
        this.subUnits[dependents[i]].beforeAnswersEl.style.setProperty("display", "flex", "important");
      }
      if(this.subUnits[dependents[i]].beforeQuestionEl != null){
        this.subUnits[dependents[i]].beforeQuestionEl.style.setProperty("display", "block", "important");
      }
      if(this.subUnits[dependents[i]].afterQuestionEl != null) {
        this.subUnits[dependents[i]].afterQuestionEl.style.setProperty("display", "block", "important");
      }
    }
    // todo only do this if the dependent answer is selected
    // for (var i = 0; i < window.qList.length; i++) {
    //   if(this.dependents.contains(window.qList[i].id)){
    //     console.log('i am here');
    //     window.qList[i].showQuestions();
    //   }
    // }
  }

}
Question.prototype.hideQuestions = function(){
  // console.log('hide');
  // console.log(this);
  // console.log(this.dependents);
  var keys = Object.keys(this.answers);
  for (var i = 0; i < keys.length; i++) {
    // console.log('keys');
    // console.log(keys);
    for (var j = 0; j < this.answers[keys[i]].length; j++) {
      // console.log('this.answers[keys[i]]');
      // console.log();
      // console.log(this.subUnits[this.answers[keys[i]][j]]);
      this.subUnits[this.answers[keys[i]][j]].questionEl.style.setProperty("display", "none", "important");
      this.subUnits[this.answers[keys[i]][j]].baseEl.style.setProperty("display", "none", "important");
      this.subUnits[this.answers[keys[i]][j]].baseEl.setAttribute("data-question-optional", "t");

      if(this.subUnits[this.answers[keys[i]][j]].afterAnswersEl != null){
        this.subUnits[this.answers[keys[i]][j]].afterAnswersEl.style.setProperty("display", "none", "important");
      }
      if(this.subUnits[this.answers[keys[i]][j]].beforeAnswersEl != null){
        this.subUnits[this.answers[keys[i]][j]].beforeAnswersEl.style.setProperty("display", "none", "important");
      }
      if(this.subUnits[this.answers[keys[i]][j]].beforeQuestionEl != null){
        this.subUnits[this.answers[keys[i]][j]].beforeQuestionEl.style.setProperty("display", "none", "important");
      }
      if(this.subUnits[this.answers[keys[i]][j]].afterQuestionEl != null) {
        // console.log('hi');
        // console.log(this.subUnits[this.answers[keys[i]][j]].afterQuestionEl);
        this.subUnits[this.answers[keys[i]][j]].afterQuestionEl.style.setProperty("display", "none", "important");
      }
    }
  }
  //check and see if its already hidden

  //determine if there are subelements and hide them




}
window.qList = [];
for (var i = 0; i < conditionalConfig.length; i++) {
  window.qList[i] = new Question(conditionalConfig[i]);
  window.qList[i].hideQuestions();
}

var piInputs = PulseInsightsObject.survey.widget.querySelectorAll('._pi_free_text_question_field');
for (var i = 0; i < piInputs.length; i++) {
  piInputs[i].addEventListener('keypress', function() {
    this.parentNode.parentNode.setAttribute('data-answer', this.value);
  });
  piInputs[i].addEventListener('keyup', function() {
    this.parentNode.parentNode.setAttribute('data-answer', this.value);
  });
}

</script>
