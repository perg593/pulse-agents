# URL Rewriting Polish - Update After Testing

## Date: 2025-12-04

## Findings from HAR File Analysis (uncommongoods-2.har)

### Critical Issue: JavaScript Interception Not Working

**Problem**: The JavaScript interception script is **NOT being injected** into the HTML.

**Evidence**:
- HAR file search found **zero matches** for:
  - `data-pi-proxy="url-rewriting"`
  - `rewriteUrlForJs`
  - `window.fetch.*originalFetch`
- Relative paths like `/js/20251203154408-374/ug-spa/dist/4352.9b506679dc57be2f.js` are still being requested directly to `localhost:3100` without `/proxy?url=`
- These requests return `{"error": "Missing url query parameter"}` (404)

### Root Cause Analysis

1. **Script Injection Issue**: The `injectUrlRewritingScript()` function may not be executing correctly, or the script is being stripped/blocked
2. **Timing Issue**: The script might be injected but executed after webpack's code splitting has already run
3. **Webpack Code Splitting**: Uncommongoods.com uses webpack with dynamic imports for code splitting. These generate script tags dynamically that may bypass our interception

### Current Status

**What's Working**:
- HTML attribute rewriting for static URLs in HTML source
- Base href injection
- Some resources are successfully proxied (runtime.js, polyfills.js, main.js show successful proxy requests in HAR)

**What's NOT Working**:
- JavaScript interception script injection
- Dynamic script tag creation (webpack code splitting chunks)
- Relative paths generated by JavaScript at runtime

## Updated Implementation Plan

### Phase 1: Fix Script Injection (CRITICAL)

**Priority**: HIGH - This is blocking the main functionality

**Root Cause Identified**:
The script checks `if (!window.location.href.includes('/proxy?url='))` and returns early. However, when the page loads in an iframe, `window.location.href` refers to the iframe's location (which is the proxied page), but the check might fail if:
1. The URL is encoded differently
2. The iframe context changes the location object
3. The script runs before location is fully set

**Fix Required**:
1. **Remove or Fix Early Return Check**
   - The check `if (!window.location.href.includes('/proxy?url='))` is too restrictive
   - Should check `document.location` or use a more reliable method
   - Consider checking for proxy origin instead of URL pattern

2. **Verify Script Injection**
   - Add logging to `injectUrlRewritingScript()` to confirm it's being called
   - Check if script is actually present in HTML response (test with curl)
   - Verify script placement (must be early in `<head>`)

3. **Fix Script Execution Context**
   - Ensure script runs in correct context (not blocked by CSP)
   - Use `document.currentScript` or other methods to verify execution
   - Add console.log statements to injected script to verify execution

4. **Improve URL Detection**
   - Use `document.location.href` instead of `window.location.href`
   - Check for proxy origin in multiple ways
   - Add fallback detection methods

**Files to Update**:
- `functions/proxy.js` - `injectUrlRewritingScript()` function
- `preview/scripts/background-proxy-server.js` - `injectUrlRewritingScript()` function

### Phase 2: Enhance Dynamic Script Tag Interception

**Priority**: HIGH - Webpack code splitting relies on this

1. **Improve Script Tag Interception**
   - Current implementation intercepts `createElement` but may miss webpack's dynamic script creation
   - Need to intercept earlier in the chain (before webpack's code runs)
   - Consider intercepting `appendChild`/`insertBefore` on script elements

2. **Handle Webpack-Specific Patterns**
   - Webpack uses `__webpack_require__.e()` for code splitting
   - May need to intercept webpack's internal module loading
   - Consider intercepting `document.createElement` more aggressively

**Files to Update**:
- JavaScript interception script in both proxy files
- May need to add webpack-specific interception

### Phase 3: Improve Relative URL Resolution

**Priority**: MEDIUM - Secondary issue

1. **Fix Base URL Resolution**
   - Current implementation uses `getCurrentOrigin()` which may not work correctly
   - Need to ensure base URL includes full path (not just origin)
   - Handle cases where page URL has query parameters

2. **Better URL Context**
   - Extract original target URL from proxy URL more reliably
   - Use document.baseURI if available
   - Fallback to window.location with proper parsing

**Files to Update**:
- JavaScript interception script's `getCurrentOrigin()` function
- `rewriteUrlForJs()` function in injected script

### Phase 4: Add Comprehensive Testing

**Priority**: MEDIUM - Ensure fixes work

1. **Test Script Injection**
   - Verify script appears in HTML response
   - Verify script executes in browser
   - Test with uncommongoods.com specifically

2. **Test Webpack Code Splitting**
   - Test with sites using webpack
   - Verify dynamic chunks are intercepted
   - Test with different webpack configurations

3. **Integration Test Updates**
   - Add test that verifies script injection
   - Add test for webpack code splitting scenario
   - Test relative path resolution

**Files to Update**:
- `tests/integration/preview/url-rewriting.test.mjs`
- Add specific uncommongoods.com test case

## Immediate Action Items

1. **Fix Early Return Check** (URGENT)
   - Remove or fix the `window.location.href.includes('/proxy?url=')` check
   - Use `document.location.href` or check for proxy origin
   - Add multiple detection methods as fallback

2. **Debug Script Injection** (URGENT)
   - Add console logging to verify script is injected
   - Check HTML response to confirm script presence (test with curl)
   - Verify script placement in `<head>` before other scripts

3. **Fix Script Execution** (URGENT)
   - Ensure script runs before webpack code
   - Fix any syntax errors in injected script
   - Verify script doesn't conflict with page scripts
   - Add error handling to prevent script from breaking page

4. **Enhance Dynamic Script Interception** (HIGH)
   - Improve `createElement` interception for script tags
   - Intercept `appendChild`/`insertBefore` on script elements
   - Handle webpack's dynamic script creation patterns

5. **Test with Uncommongoods.com** (HIGH)
   - Verify script injection works
   - Test that dynamic chunks are intercepted
   - Confirm no 404 errors for JS chunks
   - Verify HAR file shows proxied URLs for all chunks

## Success Criteria

- [ ] JavaScript interception script is present in HTML response (verified via curl/HAR)
- [ ] Script executes before webpack code runs (verified via console logs)
- [ ] Early return check doesn't prevent script execution
- [ ] Dynamic script tags created by webpack are intercepted
- [ ] Relative paths like `/js/...` are rewritten to `/proxy?url=...`
- [ ] No 404 errors for webpack code splitting chunks
- [ ] Uncommongoods.com loads without missing resources
- [ ] HAR file shows all JS chunks going through `/proxy?url=...` endpoint

## Testing Strategy

1. **Manual Testing**:
   - Load uncommongoods.com through proxy
   - Check browser console for script execution
   - Verify network tab shows proxied URLs for chunks

2. **Automated Testing**:
   - Add HAR file analysis to integration tests
   - Verify script injection in HTML response
   - Check for 404 errors in test results

3. **HAR File Analysis**:
   - Compare before/after HAR files
   - Verify reduction in 404 errors
   - Confirm all JS chunks go through proxy

## Related Issues

- Original issue: Relative paths not being rewritten (uncommongoods-1.har)
- Current issue: JavaScript interception not working (uncommongoods-2.har)
- Screenshot shows: `{"error": "Missing url query parameter"}` for direct requests

## Next Steps

1. **Fix early return check** in `injectUrlRewritingScript()` - Change from `window.location.href.includes('/proxy?url=')` to more reliable detection
2. **Add debugging** to verify script injection and execution
3. **Test script injection** by fetching HTML directly and checking for script tag
4. **Enhance dynamic script interception** to catch webpack's code splitting
5. **Test with uncommongoods.com** and verify HAR file shows improvement
6. **Update documentation** with findings and fixes

## Code Changes Required

### In `functions/proxy.js` and `preview/scripts/background-proxy-server.js`:

1. **Fix the early return check**:
```javascript
// Current (problematic):
if (!window.location.href.includes('/proxy?url=')) {
  return;
}

// Should be:
// Check if we're on a proxied page more reliably
const isProxied = document.location.href.includes('/proxy?url=') ||
                  document.location.origin === PROXY_BASE.replace(/\/$/, '') ||
                  (document.referrer && document.referrer.includes('/proxy?url='));
if (!isProxied) {
  return;
}
```

2. **Add debugging**:
```javascript
console.log('[PI-Proxy] URL rewriting script injected');
console.log('[PI-Proxy] Proxy base:', PROXY_BASE);
console.log('[PI-Proxy] Current origin:', getCurrentOrigin());
```

3. **Improve script tag interception**:
```javascript
// Intercept appendChild/insertBefore on script elements
const originalAppendChild = Node.prototype.appendChild;
const originalInsertBefore = Node.prototype.insertBefore;

Node.prototype.appendChild = function(child) {
  if (child.tagName === 'SCRIPT' && child.src) {
    child.src = rewriteUrlForJs(child.src, currentOrigin);
  }
  return originalAppendChild.call(this, child);
};
```

