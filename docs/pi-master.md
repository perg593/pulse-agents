# Pulse Insights “pi-master” Output Documentation

## Overview

“pi-master” is the client-facing bundle that Pulse Insights injects onto partner sites.  
The bundle renders survey widgets inside `#_pi_surveyWidgetContainer` and layers three CSS sources:

1. **Default widget chrome** – baseline layout + typography per widget family.
2. **Client theme** – brand-specific token output generated by the theme generator.
3. **Survey overrides** – optional tweaks authored at the survey level.

The widgets are delivered as self-contained HTML snippets that the preview app also consumes.

```
preview/widgets/
├── docked_widget/               # Desktop docked widget snippets
├── docked_widget_mobile/        # Mobile docked snippets
├── overlay/ …                   # Overlay family variants
├── inline/ …                    # Inline family variants
├── bottom_bar/ …                # Bottom bar family variants
└── css/                         # Shared baseline styles
```

## HTML Template Anatomy

Every widget snippet begins with the same `<style>` and `<script>` preamble:

```html
<style data-style-src="../css/styles_default_docked_widget.css"></style>
<style id="client-theme-css"></style>
<style data-style-src="../css/styles_survey_overrides.css"></style>
<!-- Inline widgets also include styles_inline_flex_display.css -->
<script src="../theme-loader.js"></script>
```

- `data-style-src` attributes reference baseline CSS files that the loader fetches and inlines.
- `#client-theme-css` is a placeholder that receives theme CSS at runtime.
- Inline widgets add `styles_inline_flex_display.css` to enforce flex layouts across engines.

The markup that follows is shared across families:

```html
<div id="_pi_surveyWidgetContainer">
  <div id="_pi_surveyWidget"
       role="application"
       survey-widget-type="dockedwidgetsurvey"
       data-question-id="25285"
       data-answers-layout="fixed"
       data-answers-per-row="3"
       …>
    …
  </div>
</div>
```

Key attributes/classes:

- `#_pi_surveyWidget`: main widget shell. `survey-widget-type` distinguishes families for CSS.
- `. _pi_closeButton`, `._pi_widgetContentContainer`, `._pi_question`, `._pi_answers_container`
  – semantic hooks for styling/analytics.
- `data-*` attributes (`data-answers-layout`, `data-answers-alignment`, `data-radio-button`) drive CSS modifiers (see `styles_inline_flex_display.css`).

## CSS Layers

### 1. Default Styles (`preview/widgets/css/styles_default_*.css`)

Minified CSS that sets:

- Positioning (fixed vs. inline), z-index, default padding/margins.
- Baseline typography (`font-family: Helvetica, Arial, sans-serif` etc.).
- Answer list structure and hover states.
- Special-case elements per widget family (e.g., docked widget width/right offset).

### 2. Client Theme (`#client-theme-css`)

Loaded from `/theme-generator/output/client-themes/{client}/{theme}.css`.

Generated CSS uses a `:root` block (`--pi-primary`, `--pi-bg`, etc.) followed by scoped selectors (`#_pi_surveyWidgetContainer`, `. _pi_question`) to map tokens into actual styles.  
Themes cover typography, colors, spacing, and widget-specific overrides (e.g., button radius).

### 3. Survey Overrides (`styles_survey_overrides.css`)

Currently empty with a comment header. Used for last-mile tweaks authored per survey.  
Because the loader inlines this file after the theme, it can override both defaults and client themes.

### Inline Layout Helpers (`styles_inline_flex_display.css`)

Applied to inline widgets. Normalizes answer lists to flexible layouts and respects attributes like `data-answers-per-row`.

## Theme Loader (`preview/widgets/theme-loader.js`)

Whereas the legacy widgets relied on static `<link>` tags, the new loader:

1. Fetches each `data-style-src` file and injects its contents into the inline `<style>`.
2. Reads the `theme` query parameter (`client/theme-id`).
3. Fetches the generated theme CSS and inlines it into `#client-theme-css`.
4. Clears the theme placeholder if no parameter is present.

This mirrors production’s inline `<style class="survey-XXXX">` output and keeps CSS self-contained for embedding.

## Widget Families (Desktop + Mobile)

| Directory                     | `survey-widget-type`      | Notes                                     |
|-------------------------------|---------------------------|-------------------------------------------|
| `docked_widget/`              | `dockedwidgetsurvey`      | Fixed-position panel, default width 300px |
| `docked_widget_mobile/`       | same                      | Mobile breakpoint tweaks                  |
| `overlay/`, `overlay_mobile/` | `fullscreensurvey`        | Fullscreen/overlay layouts                |
| `inline/`, `inline_mobile/`   | `inlinesurvey`            | Embeds in-page; flex helper required      |
| `bottom_bar/`                 | `bottombarsurvey`         | Docked to page bottom                     |
| `top_bar/`                    | `topbarsurvey`            | Docked to page top                        |

Each directory contains variants (`single_choice_standard_buttons.html`, `multiple_choice.html`, etc.) that share the preamble and structure.

## JavaScript Runtime Behavior

The preview repo only ships the lightweight `theme-loader.js`, but the live pi-master bundle wraps these snippets with a richer runtime. The production script is responsible for:

- **Bootstrap:** injecting the widget HTML into the host page, applying the CSS layers (now mirrored by `theme-loader.js`), and adding the necessary ARIA attributes.
- **Survey state management:** toggling `_pi_widgetContentContainer`, handling question progression, pagination, thank-you states, and communicating with Pulse Insights APIs for response submission. Most of this logic keys off `data-question-id`, `data-question-type`, and `data-answers-*` attributes present in the markup.
- **Interaction handlers:** binding click/touch events to `._pi_closeButton`, answer options (`ul._pi_answers_container li`), start buttons, and footer CTAs. These handlers update selection classes (e.g., `.selected`) that drive the CSS highlights.
- **Analytics + instrumentation:** publishing events (survey opened, answer selected, submitted, closed) to the pi-master event bus. These events typically include the IDs exposed in `data-*` attributes so downstream systems can reconcile analytics with survey definitions.
- **Accessibility helpers:** enforcing focus traps inside the widget, toggling `_pi_accessibilityHidden`, and managing `aria-describedby` relationships for error messaging.

While the detailed implementation lives outside this repo, the HTML/CSS here is designed to expose the right hooks for that runtime. Any changes to structure or naming must be vetted against the production pi-master script.

## Survey Overrides Workflow

`preview/widgets/css/styles_survey_overrides.css` is loaded across every widget instance after the client theme. Use it for:

- Per-survey tweaks that should not ship with the base theme (e.g., temporary campaigns, A/B tests).
- Emergency fixes while a new theme is being generated.
- Experimenting with new selectors before turning them into tokens.

Recommended workflow:

1. Copy the Survey ID (e.g., `7709`) and scope overrides with `.survey-7709` when targeting production output to avoid unintended bleed.
2. Author CSS inside `styles_survey_overrides.css` and refresh the preview — the loader already inlines the file.
3. Once stable, consider promoting the change into a theming token so future surveys inherit it automatically.

## Build & Packaging Workflow

Although pi-master packaging happens down the line, the repo already mirrors the important steps:

1. **Generate themes:**  
   - `cd theme-generator`  
   - `node main.js <url> <client>` or use existing analysis JSON to populate `theme-generator/output/client-themes/<client>/`.
2. **Refresh preview assets:**  
   - `npm run preview:build` (from `theme-generator/`) regenerates the manifest and default CSS that the preview UI consumes.
3. **Assemble widget snippets:**  
   - `preview/widgets/` contains the authoritative HTML. Keep this directory tidy; `widget_html.zip` can be shipped to QA or the pi-master packaging step.
4. **Bundle for deployment (outside this repo):**  
   - The downstream pi-master build pulls `client-themes`, the widget snippets, and runtime JS into a CDN bundle. Ensure `preview/scripts/build-preview-data.js` and the manifest remain in sync so the preview always reflects deployable assets.

Document any additional build tooling (e.g., gulp/webpack scripts) here once the packaging pipeline is wired into source control.

## Theme Token Reference

Themes produced by the generator expose two groups of variables:

### Legacy root variables

Declared in `:root` in the four-variation CSS:

| Token | Purpose | Consumed by |
| --- | --- | --- |
| `--pi-primary-color` | Legacy primary color | Old v1 widgets (kept for backward compatibility) |
| `--pi-secondary-color` | Secondary accent | Legacy components |
| `--pi-text-color` / `--pi-background-color` | Base text/background | Legacy typography |
| `--pi-border-color`, `--pi-hover-color`, `--pi-box-shadow`, `--pi-border-radius` | Container chrome | Legacy shadows/borders |
| `--pi-font-family` | Font stack | Legacy typography |

### Tokenized container variables (preferred)

Defined under `#_pi_surveyWidgetContainer` in the token-driven build (`preview/dist/default.css` and `generate-theme-v2.mjs` output):

| Token | Description |
| --- | --- |
| `--pi-font`, `--pi-close-font`, `--pi-close-size` | Global typography for body + close control |
| `--pi-text`, `--pi-bg` | Widget body colors |
| `--pi-primary`, `--pi-primary-hover`, `--pi-primary-active`, `--pi-on-primary` | CTA colors & states |
| `--pi-answer-border`, `--pi-radio-border` | Answer tile borders & radio controls |
| `--pi-input-border`, `--pi-input-focus`, `--pi-input-height`, `--pi-input-radius` | Text input chrome |
| `--pi-muted` | Secondary text color (helper text, footers) |
| `--pi-radius-sm`, `--pi-radius-md` | Radius scale for tiles/buttons |
| `--pi-shadow-bar` | Drop-shadow used by bar widgets |
| `--pi-gap-row`, `--pi-gap-col`, `--pi-gap-row-mobile`, `--pi-gap-col-mobile` | Tile spacing (desktop & mobile) |
| `--pi-btn-pad-desktop`, `--pi-btn-pad-mobile`, `--pi-btn-weight` | CTA sizing |
| `--pi-radio-outer`, `--pi-radio-inner`, `--pi-radio-bw`, `--pi-radio-tile` | Radio button geometry |
| `--pi-align-radio-on`, `--pi-align-radio-off` | Text alignment when radios are on/off |
| `--pi-question-size`, `--pi-answer-size`, `--pi-body-size`, `--pi-caption-size` | Typography scale |
| `--pi-question-weight`, `--pi-answer-weight`, `--pi-body-weight`, `--pi-caption-weight` | Weight scale |
| `--pi-mobile-question-size`, `--pi-mobile-answer-size`, `--pi-mobile-question-weight`, `--pi-mobile-answer-weight` | Mobile typography overrides |

When introducing new design requirements, add tokens in `generate-theme-v2.mjs`, update the reference table above, and ensure widgets read from the new variables.
